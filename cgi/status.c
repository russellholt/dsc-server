/* <plaintext> */#include <stdio.h>#include <stdlib.h>#include "entry.h"#ifndef debug#define debug 0#endifchar *skipspaces(char *p);/* DoCGIThing: the 'main' routine; called from cgimain.c */void DoCGIThing(entries, m)entry entries[];int m;	/* max */{int x;FILE *fp;char line[80];char name[40];char status[40];char coord[40];char xc[40];char yc[40];char *ptr;int l;char syscl[256];char tempfile[50];char infile[50];char *absdir = "/www/htdocs";char plotfile[256];char outputfile[256];char *imagedir = "/status/";char *bigprefix = "big-";char *pnmpaste = "/mongo/apps/netpbm/bin/pnmpaste";char *ppmtogif = "/mongo/apps/netpbm/bin/ppmtogif";int big = 0;int iter=0;char sourceimage[40];char imagelist[3][40], word[3][40];char *image;	/* points to the current image in the imagelist */char *datafile, *lights;	/*	 * create unique file names for temp and output files	 */	sprintf(tempfile, "/tmp/status-temp%d%d.ppm", iter, getpid());	lights = datafile = NULL;	for(x=0; x<=m; x++)	{		printf("looking at \"%s\"<p>", entries[x].name);		if (strcmp(entries[x].name, "lights") == 0)		{			printf("found lights at %d<p>", x);			lights = entries[x].val;		}		else			if (strcmp(entries[x].name, "file") == 0)			{				datafile = entries[x].val;				printf("found file at %d<p>", x);			}	}	printf("<title>Status</title>");    printf("<center><H1>Status</H1><HR></center>");	big = (entries[0].val[0] == 'b');	printf("<img src=\"/status/%sred-stop.gif\"><p>", big?"big-":"");	printf("Trying to open '%s'<p>", datafile);	if (m < 0)		fp = fopen("/www/htdocs/status-map.txt", "r");	else		fp = fopen(datafile, "r");	if (fp)	{		fscanf(fp, "%s", outputfile);		fscanf(fp, "%s", sourceimage);		sprintf(plotfile, "%s%s", absdir, sourceimage);		strcpy(infile, plotfile);	/* plotfile to infile */		printf("Source image file is %s<p>\n", sourceimage);		printf("<center>Key word list:");		printf("<table border=1 cellpadding=3 cellspacing=1>");		for(x=0; x<3; x++)		{			fscanf(fp, "%s %s", imagelist[x], word[x]);			printf("<tr><td>%s</td><td>%s<br></td></tr>",				imagelist[x], word[x]);		}		printf("</table><p>\n");		printf("<center><table border=2 cellpadding=3>\n");		printf("<tr><td><b>Name</b></td>");		printf("<td><b>Status</b></td>");		printf("<td align=center><b>x</b></td>");		printf("<td align=center><b>y</b></td></tr>");		while (!feof(fp))		{			fgets(line, 80, fp);			if (feof(fp))	/* premature end ? */				break;			if (line[0] == '#')	/* skip comment */				continue;			if (line[0] == '\n')	/* skip blank line */				continue;			sscanf(line, "%s %s %s", name, status, coord);			sscanf(coord, "(%[^(),], %[^(),]", xc, yc);			printf("<tr><td> %s </td> <td> %s </td>", name, status);			printf("<td align=center> %s </td>", xc);			printf("<td align=center> %s <br></td></tr>", yc);			for(x=0; x<3; x++)				if (strcmp(status, word[x]) == 0)				{					image = imagelist[x];					break;				}			/* print the pnm command to plot the image			 * pnmpaste imagedir/[big-]file x y tempfile > tempfile			 *			 */			sprintf(syscl, "%s %s%s%s%s %s %s %s > %s",				pnmpaste, absdir, imagedir, big?bigprefix:"", image, xc, yc,				infile, tempfile);			printf("<p>%s<p>", syscl);			system(syscl);			if (iter)	/* not the first one! */				unlink(infile);	/* remove source file */			strcpy(infile, tempfile);	/* copy tempfile to infile */			sprintf(tempfile, "/tmp/status-temp%d%d.ppm", ++iter, getpid());		}		printf("</table></center>");		fclose(fp);		/* 'infile' holds final image (ie, the next image that would		 * be operated on..  */		unlink(outputfile);		sprintf(syscl, "%s %s > %s%s", ppmtogif, infile, absdir, outputfile);		printf("<p>%s<p>", syscl);		system(syscl);		unlink(infile);	/* remove source file */		printf("<p><img src=\"%s\"><p>", outputfile);		printf("image is referenced as %s<p>", outputfile);	}	else	{		printf("Unable to read status data.\n");	}	if (m >= 0)	/* if there is CGI data */	{		printf("<p><hr>CGI data was..<p>\n");		for (x=0;x<=m;x++)			printf("<b>%s</b> %s<br>\n",entries[x].name, entries[x].val);	}	printf("<p><HR><a href=\"/metaURL\">metaURL</a>");}char *skipspaces(char *p){char *ptr = p;	while(*ptr && *ptr == ' ')		ptr++;	return ptr;}