/* Status 3 * * Called from the form produced by status2. * * Produces a bunch of 'sed' commands to modify the status * configuration file, then calls 'pgif' to create the new image. *  * New thing: the first line of the status config file is now the * name of the output image file. * */#include <stdio.h>#include <stdlib.h>#include "entry.h"#ifndef debug#define debug 0#endifchar *skipspaces(char *p);/* DoCGIThing: the 'main' routine; called from cgimain.c */void DoCGIThing(entries, m)entry entries[];int m;	/* max */{int x;FILE *fp, *sedfp;char line[80];char outputgiffile[80];char name[40];char status[40];char coord[40];char xc[40];char yc[40];char *ptr;int l;char syscl[256];char tempfile[50];char infile[50];char outfile[50];char *absdir = "/www/htdocs";char *imagedir = "/status/";int big = 0;int iter=0;char sourceimage[40];char imagelist[3][40], word[3][40];char *image;	/* points to the current image in the imagelist */char *datafile, *lights;char *pgif = NULL;	lights = datafile = NULL;	sprintf(tempfile, "/tmp/stat-sed%d", getpid());	sedfp = fopen(tempfile, "w");	/* find status map data file in cgi data */	for(x=0; x<=m; x++)	{			if (strcmp(entries[x].name, "file") == 0)				datafile = entries[x].val;			else			if (strcmp(entries[x].name, "pgif") == 0)				pgif = entries[x].val;	}	printf("<title>Status3</title>");    printf("<center><H1>Status3</H1><HR></center>");	printf("datafile = %s<p>", datafile);	printf("pgif = %s<p>", pgif);	if (m < 0)		fp = fopen("/www/htdocs/status-map.txt", "r");	else		fp = fopen(datafile, "r");	if (fp && sedfp)	{		fscanf(fp, "%s", outputgiffile);	/* don't need this */		fscanf(fp, "%s", sourceimage);		for(x=0; x<3; x++)			fscanf(fp, "%s %s", imagelist[x], word[x]);		printf("<center>");		printf("<table border=2 cellpadding=3>\n");		printf("<tr><td><b>Name</b></td>");		printf("<td><b>Status</b></td>");		printf("<td align=center><b>x</b></td>");		printf("<td align=center><b>y</b></td></tr>");		while (!feof(fp))		{			fgets(line, 80, fp);			if (feof(fp))	/* premature end ? */				break;			if (line[0] == '#')	/* skip comment */				continue;			if (line[0] == '\n')	/* skip blank line */				continue;			sscanf(line, "%s %s %s", name, status, coord);			sscanf(coord, "(%[^(),], %[^(),]", xc, yc);			printf("<tr><td> %s </td>", name);			printf("<td> %s </td>", status);			printf("<td align=center> %s </td>", xc);			printf("<td align=center> %s <br></td></tr>", yc);			for(x=0; x<3; x++)				if (strcmp(status, word[x]) == 0)				{					image = imagelist[x];					break;				}		}		printf("</table>");		fclose(fp);		printf("</center>");		printf("<p>'sed' commands for status map '%s':<p>", datafile);		printf("<code>");		for(x=0; x<m; x++)		{			if (!strcmp(entries[x].name, "file")  ||				!strcmp(entries[x].name, "pgif") )				continue;	/* skip 'file'  and 'pgif'  */			if ((entries[x].name[0] != 'x' || entries[x].name[0] != 'y') &&				(entries[x].name[1] != '-'))			{				printf("s/%s [^ ]*/%s %s/g\n<br>", entries[x].name,					entries[x].name, entries[x].val);				fprintf(sedfp, "s/%s [^ ]*/%s %s/g\n", entries[x].name,					entries[x].name, entries[x].val);			}		}		fclose(sedfp);		sprintf(outfile, "/tmp/stat-sedout%d", getpid());		sprintf(syscl, "sed -f %s %s > %s", tempfile, datafile, outfile);		printf("<p>%s<br>", syscl);		system(syscl);		unlink(datafile);		printf("unlink %s<br>", datafile);		sprintf(syscl, "cp %s %s", outfile, datafile);		printf("%s<br>", syscl);		system(syscl);		unlink(tempfile);		unlink(outfile);		printf("unlink %s<br>", tempfile);		printf("unlink %s<br>", outfile);		sprintf(syscl, "%s %s", pgif, datafile);		printf("%s<p>", syscl);				printf("</code>");		system(syscl);		printf("<p>");		printf("%s has been updated.<p>", outputgiffile);	}	else	{		printf("Unable to read status data.\n");	}}